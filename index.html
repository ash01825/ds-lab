<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart City Traffic Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Tailwind gray-900 */
            color: #f3f4f6; /* Tailwind gray-100 */
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 1.5rem;
            height: calc(100vh - 2rem);
            padding: 1rem;
        }
        .main-panel {
            grid-column: 1 / 2;
            grid-row: 1 / 3;
            background-color: #1f2937; /* Tailwind gray-800 */
            border-radius: 0.75rem;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #374151; /* gray-700 */
        }
        .info-panel, .controls-panel {
            background-color: #1f2937;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #374151;
        }
        .road {
            background-color: #4b5563; /* Tailwind gray-600 */
            position: absolute;
        }
        .road-h { width: 100%; height: 80px; top: 50%; transform: translateY(-50%); }
        .road-v { width: 80px; height: 100%; left: 50%; transform: translateX(-50%); }
        .center-island {
            width: 80px; height: 80px;
            background-color: #374151; /* gray-700 */
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }
        .traffic-light-box {
            display: flex;
            flex-direction: column;
            gap: 4px;
            background-color: #111827;
            padding: 8px;
            border-radius: 8px;
            border: 2px solid #374151;
        }
        .light {
            width: 24px; height: 24px;
            border-radius: 50%;
            background-color: #4b5563; /* Off state */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .light.red { background-color: #ef4444; box-shadow: 0 0 12px #ef4444; }
        .light.yellow { background-color: #f59e0b; box-shadow: 0 0 12px #f59e0b; }
        .light.green { background-color: #22c55e; box-shadow: 0 0 12px #22c55e; }

        .pedestrian-signal {
            background-color: #111827;
            padding: 8px;
            border-radius: 8px;
            border: 2px solid #374151;
            width: 44px; height: 44px;
        }
        .ped-icon { transition: color 0.3s ease, filter 0.3s ease; }
        .ped-icon.red { color: #ef4444; filter: drop-shadow(0 0 5px #ef4444); }
        .ped-icon.green { color: #22c55e; filter: drop-shadow(0 0 5px #22c55e); }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-badge.green { background-color: #166534; color: #dcfce7; }
        .status-badge.yellow { background-color: #a16207; color: #fefce8; }
        .status-badge.red { background-color: #991b1b; color: #fee2e2; }
        .status-badge.blue { background-color: #1e40af; color: #dbeafe; }
        .status-badge.gray { background-color: #4b5563; color: #e5e7eb; }

        .control-button {
            transition: all 0.2s ease;
        }
        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        #log-panel {
            background-color: #111827;
            border-radius: 0.5rem;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
            color: #d1d5db; /* gray-300 */
        }
        .log-entry {
            padding: 0.25rem 0.75rem;
            border-bottom: 1px solid #374151;
        }

        /* Animations */
        @keyframes emergency-flash {
            0%, 100% { color: #3b82f6; } /* blue */
            50% { color: #ef4444; } /* red */
        }
        @keyframes vip-glow {
            0%, 100% { filter: drop-shadow(0 0 8px #f59e0b); }
            50% { filter: drop-shadow(0 0 16px #f59e0b); }
        }
        @keyframes alert-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .emergency-icon { animation: emergency-flash 1s infinite; }
        .vip-icon { animation: vip-glow 1.5s infinite ease-in-out; }
        .alert-active { animation: alert-blink 1s infinite; }

        #emergency-vehicle { transition: all 8s linear; }
        #vip-vehicle { transition: all 6s linear; }

    </style>
</head>
<body class="p-4">

    <main class="dashboard-grid">
        <!-- Intersection Panel -->
        <div class="main-panel">
            <div class="road road-h"></div>
            <div class="road road-v"></div>
            <div class="center-island"></div>

            <!-- Signal & Pedestrian Layouts -->
            <!-- Signal 1 (Top-Right) -->
            <div class="absolute top-1/2 right-1/2 -translate-y-[112px] translate-x-[48px] flex items-end gap-2">
                <div class="traffic-light-box">
                    <div id="light-1-red" class="light"></div> <div id="light-1-yellow" class="light"></div> <div id="light-1-green" class="light"></div>
                </div>
                <div class="pedestrian-signal flex items-center justify-center">
                    <svg id="ped-1" class="ped-icon w-8 h-8" viewBox="0 0 24 24"><path fill="currentColor" d="M14.5 4.5c0-1.2-1-2.2-2.2-2.2s-2.2 1-2.2 2.2c0 1.2 1 2.2 2.2 2.2s2.2-1 2.2-2.2M12 8c-2.3 0-6.5 1.2-6.5 3.5V14h13v-2.5C18.5 9.2 14.3 8 12 8m-6.5 8.5V21h1.5v-4.8l3-2.1l3 2.1V21h1.5v-6.5l-4.5-3.2z"/></svg>
                </div>
            </div>

            <!-- Signal 2 (Bottom-Left) -->
            <div class="absolute top-1/2 left-1/2 translate-y-[48px] -translate-x-[112px] flex items-start gap-2 scale-y-[-1] scale-x-[-1]">
                <div class="traffic-light-box">
                    <div id="light-2-red" class="light"></div> <div id="light-2-yellow" class="light"></div> <div id="light-2-green" class="light"></div>
                </div>
                <div class="pedestrian-signal flex items-center justify-center">
                    <svg id="ped-2" class="ped-icon w-8 h-8" viewBox="0 0 24 24"><path fill="currentColor" d="M14.5 4.5c0-1.2-1-2.2-2.2-2.2s-2.2 1-2.2 2.2c0 1.2 1 2.2 2.2 2.2s2.2-1 2.2-2.2M12 8c-2.3 0-6.5 1.2-6.5 3.5V14h13v-2.5C18.5 9.2 14.3 8 12 8m-6.5 8.5V21h1.5v-4.8l3-2.1l3 2.1V21h1.5v-6.5l-4.5-3.2z"/></svg>
                </div>
            </div>

            <!-- Signal 3 (Top-Left) -->
            <div class="absolute top-1/2 left-1/2 -translate-y-[48px] -translate-x-[112px] flex items-center gap-2 -rotate-90">
                <div class="traffic-light-box">
                    <div id="light-3-red" class="light"></div> <div id="light-3-yellow" class="light"></div> <div id="light-3-green" class="light"></div>
                </div>
                <div class="pedestrian-signal flex items-center justify-center">
                    <svg id="ped-3" class="ped-icon w-8 h-8" viewBox="0 0 24 24"><path fill="currentColor" d="M14.5 4.5c0-1.2-1-2.2-2.2-2.2s-2.2 1-2.2 2.2c0 1.2 1 2.2 2.2 2.2s2.2-1 2.2-2.2M12 8c-2.3 0-6.5 1.2-6.5 3.5V14h13v-2.5C18.5 9.2 14.3 8 12 8m-6.5 8.5V21h1.5v-4.8l3-2.1l3 2.1V21h1.5v-6.5l-4.5-3.2z"/></svg>
                </div>
            </div>

            <!-- Signal 4 (Bottom-Right) -->
            <div class="absolute top-1/2 right-1/2 translate-y-[48px] translate-x-[112px] flex items-center gap-2 rotate-90 scale-y-[-1] scale-x-[-1]">
                <div class="traffic-light-box">
                    <div id="light-4-red" class="light"></div> <div id="light-4-yellow" class="light"></div> <div id="light-4-green" class="light"></div>
                </div>
                <div class="pedestrian-signal flex items-center justify-center">
                    <svg id="ped-4" class="ped-icon w-8 h-8" viewBox="0 0 24 24"><path fill="currentColor" d="M14.5 4.5c0-1.2-1-2.2-2.2-2.2s-2.2 1-2.2 2.2c0 1.2 1 2.2 2.2 2.2s2.2-1 2.2-2.2M12 8c-2.3 0-6.5 1.2-6.5 3.5V14h13v-2.5C18.5 9.2 14.3 8 12 8m-6.5 8.5V21h1.5v-4.8l3-2.1l3 2.1V21h1.5v-6.5l-4.5-3.2z"/></svg>
                </div>
            </div>

            <!-- Event Visualizations -->
            <div id="alert-overlay" class="hidden absolute inset-0 bg-red-900/50 backdrop-blur-sm z-40 flex items-center justify-center text-center p-8">
                <div class="alert-active">
                    <svg class="w-24 h-24 text-red-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    <h2 class="text-4xl font-bold mt-4 text-white" id="alert-message"></h2>
                </div>
            </div>

            <div id="emergency-vehicle" class="absolute z-30 opacity-0 text-blue-500">
                <svg class="w-12 h-12 emergency-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19 13v-2h-2V7h-2v4h-2V7h-2v4H9V7H7v4H5v2h2v2H5v2h2v-2h2v2h2v-2h2v2h2v-2h2v2h2v-2z"/></svg>
            </div>
            <div id="vip-vehicle" class="absolute z-30 opacity-0 text-amber-400">
                <svg class="w-12 h-12 vip-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99M6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16m11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5s1.5.67 1.5 1.5s-.67 1.5-1.5 1.5M5 11l1.5-4.5h11L19 11z"/></svg>
            </div>
            <div id="deadlock-viz" class="hidden absolute z-30 inset-0 flex items-center justify-center">
                <div id="deadlock-car-1" class="absolute text-3xl transition-opacity duration-500">🚗</div>
                <div id="deadlock-car-2" class="absolute text-3xl transition-opacity duration-500">🚙</div>
                <div id="deadlock-q-1" class="absolute text-5xl text-yellow-400 font-bold opacity-0 transition-opacity duration-500">❓</div>
                <div id="deadlock-q-2" class="absolute text-5xl text-yellow-400 font-bold opacity-0 transition-opacity duration-500">❓</div>
                <div id="deadlock-ok-1" class="absolute text-5xl text-green-400 font-bold opacity-0 transition-opacity duration-500">✅</div>
                <div id="deadlock-ok-2" class="absolute text-5xl text-green-400 font-bold opacity-0 transition-opacity duration-500">✅</div>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="info-panel flex flex-col justify-between">
            <div>
                <h2 class="text-2xl font-bold text-white border-b-2 border-gray-700 pb-2 mb-4">System Status</h2>
                <div class="space-y-3 text-lg">
                    <div class="flex justify-between items-center"><span>System Clock:</span> <span id="clock-sync-status" class="status-badge"></span></div>
                    <div class="flex justify-between items-center"><span>Database:</span> <span id="db-sync-status" class="status-badge"></span></div>
                    <div class="flex justify-between items-center"><span>Critical Section:</span> <span id="critical-section-status" class="status-badge"></span></div>
                </div>

                <h3 class="text-xl font-semibold text-white mt-6 border-b border-gray-700 pb-1 mb-3">Timers</h3>
                <div class="space-y-2 text-lg">
                    <div class="flex justify-between items-center"><span>Roads 1-2:</span> <span id="timer-1-2" class="font-mono">0s</span></div>
                    <div class="flex justify-between items-center"><span>Roads 3-4:</span> <span id="timer-3-4" class="font-mono">0s</span></div>
                </div>

                <h3 class="text-xl font-semibold text-white mt-6 border-b border-gray-700 pb-1 mb-3">Controllers</h3>
                <div class="space-y-2 text-lg">
                    <div class="flex justify-between items-center"><span>Primary:</span> <span id="controller-primary" class="status-badge"></span></div>
                    <div class="flex justify-between items-center"><span>Backup:</span> <span id="controller-backup" class="status-badge"></span></div>
                </div>
            </div>
            <div id="connection-status" class="text-center font-semibold py-2 rounded-lg bg-red-800 text-red-100">
                DISCONNECTED
            </div>
        </div>

        <!-- Controls & Log Panel -->
        <div class="controls-panel">
            <h2 class="text-2xl font-bold text-white border-b-2 border-gray-700 pb-2 mb-4">Simulate Events</h2>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="trigger('emergency')" class="control-button bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">Emergency</button>
                <button onclick="trigger('vip')" class="control-button bg-amber-500 hover:bg-amber-400 text-black font-bold py-2 px-4 rounded-lg">VIP Vehicle</button>
                <button onclick="trigger('deadlock')" class="control-button bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg">Gridlock</button>
                <button onclick="trigger('failover')" class="control-button bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Failover</button>
                <button onclick="trigger('alert')" class="control-button bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg">System Alert</button>
            </div>
             <h2 class="text-xl font-bold text-white border-b-2 border-gray-700 pb-2 mb-2">System Log</h2>
             <div id="log-panel"></div>
        </div>
    </main>

    <script>
        const WS_URL = "ws://localhost:8765";
        let websocket;

        function connect() {
            websocket = new WebSocket(WS_URL);

            websocket.onopen = () => {
                console.log("Connected to WebSocket server.");
                document.getElementById('connection-status').textContent = 'CONNECTED';
                document.getElementById('connection-status').className = 'text-center font-semibold py-2 rounded-lg bg-green-800 text-green-100';
            };

            websocket.onmessage = (event) => {
                const state = JSON.parse(event.data);
                updateUI(state);
            };

            websocket.onclose = () => {
                console.log("Disconnected. Retrying in 3 seconds...");
                document.getElementById('connection-status').textContent = 'RECONNECTING...';
                document.getElementById('connection-status').className = 'text-center font-semibold py-2 rounded-lg bg-yellow-800 text-yellow-100';
                setTimeout(connect, 3000);
            };

            websocket.onerror = (error) => {
                console.error("WebSocket error:", error);
                websocket.close();
            };
        }

        function trigger(action) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({ action: `trigger_${action}` }));
            }
        }

        function setBadge(element, text, type) {
            element.textContent = text.toUpperCase();
            let colorClass = 'gray';
            if (type === 'green') colorClass = 'green';
            else if (type === 'yellow') colorClass = 'yellow';
            else if (type === 'red') colorClass = 'red';
            else if (type === 'blue') colorClass = 'blue';
            element.className = `status-badge ${colorClass}`;
        }

        function updateUI(state) {
            // Update traffic lights
            for (let i = 1; i <= 4; i++) {
                const signalState = state.signals[i.toString()];
                document.getElementById(`light-${i}-red`).classList.toggle('red', signalState === 'red');
                document.getElementById(`light-${i}-yellow`).classList.toggle('yellow', signalState === 'yellow');
                document.getElementById(`light-${i}-green`).classList.toggle('green', signalState === 'green');

                const pedState = state.pedestrians[i.toString()];
                document.getElementById(`ped-${i}`).classList.toggle('red', pedState === 'red');
                document.getElementById(`ped-${i}`).classList.toggle('green', pedState === 'green');
            }

            // Update timers
            document.getElementById('timer-1-2').textContent = `${state.timers['1-2']}s`;
            document.getElementById('timer-3-4').textContent = `${state.timers['3-4']}s`;

            // Update status panel
            setBadge(document.getElementById('clock-sync-status'), state.clock_sync, state.clock_sync === 'SYNCED' ? 'green' : 'red');
            setBadge(document.getElementById('db-sync-status'), state.database_synced ? 'Synced' : 'Syncing', state.database_synced ? 'green' : 'yellow');

            let cs_status = state.critical_section;
            let cs_color = 'gray';
            if (cs_status.includes('1-2') || cs_status.includes('3-4')) cs_color = 'green';
            if (cs_status === 'transition') cs_color = 'yellow';
            if (cs_status === 'all-red' || cs_status === 'GRIDLOCK' || cs_status === 'EMERGENCY') cs_color = 'red';
            setBadge(document.getElementById('critical-section-status'), cs_status, cs_color);

            // Update controllers
            for (const controller of ['primary', 'backup']) {
                const status = state.controllers[controller];
                let color = 'gray';
                if (status === 'active') color = 'green';
                else if (status === 'standby') color = 'blue';
                else if (status === 'failed') color = 'red';
                setBadge(document.getElementById(`controller-${controller}`), status, color);
            }

            // Update Logs
            const logPanel = document.getElementById('log-panel');
            logPanel.innerHTML = state.log.map(entry => `<div class="log-entry">${entry}</div>`).join('');

            // Handle event visualizations
            handleEventVisuals(state.events);
        }

        // --- Event Visual Handlers ---
        function handleEventVisuals(events) {
            // System Alert
            const alertOverlay = document.getElementById('alert-overlay');
            if (events.alert.active) {
                document.getElementById('alert-message').textContent = events.alert.message;
                alertOverlay.classList.remove('hidden');
            } else {
                alertOverlay.classList.add('hidden');
            }

            // Emergency Vehicle
            const emergencyVehicle = document.getElementById('emergency-vehicle');
            if (events.emergency.active) {
                const road = events.emergency.road;
                emergencyVehicle.style.transition = 'none';
                emergencyVehicle.style.opacity = '1';
                if (road === '1' || road === '2') { // Vertical
                    emergencyVehicle.style.left = '50%';
                    emergencyVehicle.style.transform = 'translateX(-50%) rotate(90deg)';
                    emergencyVehicle.style.top = road === '1' ? '-10%' : '110%';
                    setTimeout(() => {
                        emergencyVehicle.style.transition = 'top 8s linear';
                        emergencyVehicle.style.top = road === '1' ? '110%' : '-10%';
                    }, 50);
                } else { // Horizontal
                    emergencyVehicle.style.top = '50%';
                    emergencyVehicle.style.transform = 'translateY(-50%)';
                    emergencyVehicle.style.left = road === '3' ? '-10%' : '110%';
                     setTimeout(() => {
                        emergencyVehicle.style.transition = 'left 8s linear';
                        emergencyVehicle.style.left = road === '3' ? '110%' : '-10%';
                    }, 50);
                }
            } else {
                 emergencyVehicle.style.opacity = '0';
            }

            // VIP Vehicle
            const vipVehicle = document.getElementById('vip-vehicle');
            if (events.vip.active) {
                const road = events.vip.road;
                vipVehicle.style.transition = 'none';
                vipVehicle.style.opacity = '1';
                if (road === '1-2') {
                    vipVehicle.style.left = '50%';
                    vipVehicle.style.transform = 'translateX(-50%) rotate(90deg)';
                    vipVehicle.style.top = '-10%';
                    setTimeout(() => {
                        vipVehicle.style.transition = 'top 6s linear';
                        vipVehicle.style.top = '110%';
                    }, 50);
                } else { // 3-4
                    vipVehicle.style.top = '50%';
                    vipVehicle.style.transform = 'translateY(-50%)';
                    vipVehicle.style.left = '-10%';
                    setTimeout(() => {
                        vipVehicle.style.transition = 'left 6s linear';
                        vipVehicle.style.left = '110%';
                    }, 50);
                }
            } else {
                vipVehicle.style.opacity = '0';
            }

            // Deadlock/Gridlock
            const deadlockViz = document.getElementById('deadlock-viz');
            if (events.deadlock.active) {
                deadlockViz.classList.remove('hidden');
                // Car positions
                document.getElementById('deadlock-car-1').style.cssText = 'top: 50%; left: 50%; transform: translate(-150%, -150%);';
                document.getElementById('deadlock-car-2').style.cssText = 'top: 50%; left: 50%; transform: translate(50%, 50%) scaleX(-1);';
                 // Question marks
                document.getElementById('deadlock-q-1').style.cssText = 'top: 50%; left: 50%; transform: translate(-250%, 0%); opacity: 1;';
                document.getElementById('deadlock-q-2').style.cssText = 'top: 50%; left: 50%; transform: translate(50%, -250%); opacity: 1;';

                if (events.deadlock.resolved) {
                    document.getElementById('deadlock-q-1').style.opacity = 0;
                    document.getElementById('deadlock-q-2').style.opacity = 0;
                    document.getElementById('deadlock-ok-1').style.cssText = document.getElementById('deadlock-q-1').style.cssText;
                    document.getElementById('deadlock-ok-2').style.cssText = document.getElementById('deadlock-q-2').style.cssText;
                    document.getElementById('deadlock-ok-1').style.opacity = 1;
                    document.getElementById('deadlock-ok-2').style.opacity = 1;
                } else {
                    document.getElementById('deadlock-ok-1').style.opacity = 0;
                    document.getElementById('deadlock-ok-2').style.opacity = 0;
                }

            } else {
                deadlockViz.classList.add('hidden');
            }
        }

        // Initial connection
        connect();
    </script>
</body>
</html>

